<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MultiMode | AbleAssist AI</title>
  <link rel="stylesheet" href="css/main.css" />
  <style>
    /* combined camera + voice layout */
    .multi-shell { padding:18px; }
    .multi-grid { display:grid; grid-template-columns: 1fr 360px; gap:28px; align-items:start; }
    .cam-panel { background: transparent; }
    .voice-panel { background: transparent; }
    /* make camera box square and ensure video fills it; minimize surrounding card chrome */
    .camera-box { width:100%; max-width:100%; aspect-ratio: 1 / 1; background:#000; border-radius:6px; overflow:hidden; display:flex; align-items:center; justify-content:center; margin:0; border: none; }
    /* remove the white card background and padding around the camera so the video is flush */
    .cam-panel.card { background: transparent; box-shadow: none; border: none; padding: 0; }
    .cam-panel.card h3 { padding: 8px 12px; margin: 0; }
    .camera-box video { width:100%; height:100%; object-fit:cover; display:block; }
    .cam-panel.card { padding: 8px; }
    /* make voice panel square as well */
    .voice-panel.card { aspect-ratio: 1 / 1; max-width:360px; display:flex; flex-direction:column; justify-content:flex-start; padding:12px; }
    .controls-row { margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    .status-area { margin-top:12px; }

    /* Gesture book modal */
    .gesture-modal { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.45); z-index: 9999; }
    .gesture-modal[aria-hidden="false"] { display: flex; }
    .gesture-modal .modal-inner { width: min(720px, 92vw); aspect-ratio: 1 / 1; background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 20px 60px rgba(0,0,0,0.4); overflow: auto; display:flex; flex-direction:column; }
    .gesture-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; margin-top:12px; align-items:start; }
    .gesture-item { display:flex; flex-direction:column; gap:8px; align-items:center; padding:6px; border:1px solid #cfcfcf; border-radius:6px; background:#fff; }
    .gesture-item .ltr { font-weight:800; font-size:16px; margin-top:4px; }
    .gesture-item img { width:80px; height:80px; object-fit:contain; border:1px solid #ddd; background:#f6f6f6; padding:6px; border-radius:6px; }
    @media (max-width:1100px) { .gesture-grid { grid-template-columns: repeat(4, 1fr); } }
    @media (max-width:700px) { .gesture-grid { grid-template-columns: repeat(3, 1fr); } .gesture-item img { width:64px; height:64px; } }

    @media (max-width:980px) {
      .multi-grid { grid-template-columns: 1fr; }
      .voice-panel.card { max-width:100%; }
    }
  </style>
</head>
<body id="multiPage">
  <header class="top-bar">
    <div style="display:flex; align-items:center; gap:12px"><h2>MultiMode</h2></div>
    <div class="top-nav">
      <a href="index.html">Home</a>
      <a href="voice.html" class="active">MultiMode</a>
    </div>
  </header>

  <main class="multi-shell">
    <section class="multi-grid">
      <!-- Camera / Sign area -->
      <div class="cam-panel card">
        <h3>Camera / Sign</h3>
        <div class="camera-box">
          <video id="camera" autoplay playsinline></video>
        </div>
        <div class="controls-row">
          <button id="retryBtn">Retry</button>
          <button id="gestureBookBtn">Gesture Book</button>
          <button id="trainToggleBtn">Train Mode</button>
          <button id="resetTrainingBtn">Reset Training</button>
          <button id="cameraToggleBtn">Camera On/Off</button>
          <button id="flipCameraBtn">Flip Preview</button>
        </div>
        <div class="status-area">
          <p id="status">Status: idle</p>
          <div id="detectedRow">Detected: <span id="detectedLetter">-</span></div>
          <textarea id="resultText" rows="3" placeholder="Recognized text will appear here..."></textarea>
        </div>
      </div>

      <!-- Voice area -->
      <aside class="voice-panel card">
        <h3>Voice Assistant</h3>
        <p id="voiceStatus">Click START to begin listening</p>
        <textarea id="voiceTranscript" rows="6" placeholder="Transcript appears here..."></textarea>
        <div style="margin-top:10px">
          <button id="startVoice">Start</button>
          <button id="stopVoice">Stop</button>
        </div>
        <div style="margin-top:12px">
          <div style="font-weight:700; margin-bottom:8px">Search</div>
          <input id="voiceSearchInput" placeholder="Search..." style="width:100%; padding:8px; border:1px solid #ccc;" />
          <div style="margin-top:8px">Toggle: <label><input id="searchToggleCheck" type="checkbox" checked /> show</label></div>
        </div>
      </aside>
    </section>
  </main>

  <!-- Gesture Book Modal -->
  <div id="gestureModal" class="gesture-modal" aria-hidden="true">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="gestureTitle">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 id="gestureTitle">Gesture Book</h3>
        <div>
          <button id="printGestureBtn" style="padding:8px 12px;border-radius:8px;font-weight:700;margin-right:8px">Print</button>
          <button id="closeGestureModal" style="padding:8px 12px;border-radius:8px;font-weight:700">Close</button>
        </div>
      </div>
      <div style="margin-top:10px">
        <div style="font-weight:700;margin-bottom:6px">Reference Sheet</div>
        <img src="images/gestures/gesture book.jpeg" alt="Gesture reference sheet" style="width:100%;max-width:520px;border:1px solid #ddd;border-radius:10px;background:#fff" />
        <div style="margin-top:8px;color:#555;font-size:13px">
          Tip: Turn <b>Train Mode</b> ON, then click a letter in the grid below while showing that hand sign to capture a sample.
        </div>
      </div>
      <div id="gesturePreview" style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;border-bottom:1px solid #eee">
        <!-- preview populated on item click -->
      </div>
      <div style="margin:8px 0 4px 0">
        <input
          id="multimodeSearch"
          type="text"
          placeholder="Search gesture..."
          style="width:100%;padding:8px;border:1px solid #ccc;border-radius:6px;"
        />
      </div>
      <div class="gesture-grid" id="gestureGrid"></div>
    </div>
  </div>

  <!-- mediapipe + sign/voice scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="js/sign.js"></script>
  <script src="js/voice.js"></script>
  <script>
    // MultiMode is intentionally light to match the landing page.
    function forceLightTheme() {
      try { document.body.classList.remove('dark'); } catch(e){}
      try { document.documentElement.setAttribute('data-theme', 'light'); } catch(e){}
      // explicit inline styles as fallback
      document.body.style.background = 'linear-gradient(180deg,#ffffff,#f7f7f7)';
      document.body.style.color = '#0b0b0b';
    }
    forceLightTheme();
    // basic bindings for camera controls (reuse functions from main.js if present)
    const cameraToggleBtn = document.getElementById('cameraToggleBtn');
    if (cameraToggleBtn) cameraToggleBtn.addEventListener('click', () => {
      // toggle camera preview via existing start/stop functions
      if (window.startCameraPreview && window.stopCameraPreview) {
        const vid = document.getElementById('camera');
        if (vid && vid.srcObject) stopCameraPreview(); else startCameraPreview();
      }
    });
    const flipCameraBtn = document.getElementById('flipCameraBtn');
    if (flipCameraBtn) flipCameraBtn.addEventListener('click', () => {
      const vid = document.getElementById('camera'); if (vid) vid.classList.toggle('mirror');
    });
    // Gesture Book modal wiring
    const gestureBookBtn = document.getElementById('gestureBookBtn');
    const gestureModal = document.getElementById('gestureModal');
    const gestureGrid = document.getElementById('gestureGrid');
    const closeGestureModal = document.getElementById('closeGestureModal');
    // ordering to match visual grid: Delete after D, Space after S
    const letters = ['A','B','C','D','Delete','E','F',
             'G','H','I','J','K','L','M',
             'N','O','P','Q','R','S','Space',
             'T','U','V','W','X','Y','Z'];
    function openGestureBook() {
      if (!gestureGrid) return;
      gestureGrid.innerHTML = '';
      const previewEl = document.getElementById('gesturePreview');
      function showPreview(name, imgSrc, meaning){
        if(!previewEl) return;
        previewEl.innerHTML = '';
        const big = document.createElement('img'); big.src = imgSrc; big.alt = name; big.style.width = '140px'; big.style.height = '140px'; big.style.objectFit = 'contain'; big.style.border = '1px solid #ddd'; big.style.padding = '8px'; big.style.background = '#fff';
        const lab = document.createElement('div'); lab.style.fontWeight='800'; lab.textContent = name;
        const meaningEl = document.createElement('div'); meaningEl.style.fontSize='13px'; meaningEl.style.color='#555'; meaningEl.textContent = meaning || '';
        previewEl.appendChild(big); previewEl.appendChild(lab); previewEl.appendChild(meaningEl);
      }
      letters.forEach(l => {
        const item = document.createElement('div'); item.className = 'gesture-item multimode-gesture';
        const label = document.createElement('div'); label.className = 'ltr'; label.textContent = l;
        const img = document.createElement('img'); img.src = `images/gestures/${l}.svg`; img.alt = `${l} sign`;
        item.appendChild(label);
        item.appendChild(img);
        item.addEventListener('click', () => {
          // Check if Train Mode is ON by checking the button state
          const trainBtn = document.getElementById('trainToggleBtn');
          const isTraining = trainBtn && (trainBtn.innerText.includes('ON') || trainBtn.classList.contains('active'));
          if (isTraining) {
            // Dispatch event to capture gesture
            try { 
              window.dispatchEvent(new CustomEvent('gesture-capture', { detail: { name: l } })); 
            } catch(e){
              console.error('Failed to dispatch gesture-capture:', e);
            }
          } else {
            showPreview(l, img.src, (l === 'Delete' ? 'Delete / backspace' : (l === 'Space' ? 'Space' : 'Letter ' + l)));
          }
        });
        gestureGrid.appendChild(item);
      });
      if (gestureModal) {
        gestureModal.setAttribute('aria-hidden','false');
        gestureModal.style.display = 'flex';
      }
    }
    function closeGestureBook() { 
      if (!gestureModal) return; 
      gestureModal.setAttribute('aria-hidden','true');
      // Also hide via display for extra safety
      if (gestureModal) gestureModal.style.display = 'none';
    }
    const printBtn = document.getElementById('printGestureBtn');
    function printGestureSheet(e){
      e.preventDefault();
      e.stopPropagation();
      if (!gestureGrid || gestureGrid.children.length === 0) {
        alert('No gestures to print. Please open the Gesture Book first.');
        return;
      }
      const w = window.open('','_blank');
      if(!w) {
        alert('Popup blocked â€” please allow popups to print.');
        return;
      }
      const style = `<style>body{font-family:Arial,Helvetica,sans-serif;padding:12px} .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px} .cell{text-align:center;padding:6px;border:1px solid #ddd} .cell img{width:96px;height:96px;object-fit:contain;border:1px solid #ccc;padding:6px;background:#fff}</style>`;
      const content = Array.from(gestureGrid.children).map(c=>{
        const lab = c.querySelector('.ltr')?.textContent || '';
        const img = c.querySelector('img')?.src || '';
        return `<div class="cell"><div style="font-weight:800;margin-bottom:6px">${lab}</div><img src="${img}" alt="${lab}"></div>`;
      }).join('');
      w.document.write(`<!doctype html><html><head><title>Gesture Sheet</title>${style}</head><body><h2>Gesture Book</h2><div class="grid">${content}</div></body></html>`);
      w.document.close();
      w.focus();
      setTimeout(()=>{ try{ w.print(); } catch(e){ console.error('Print failed:', e); } }, 300);
    }
    if (printBtn) {
      printBtn.addEventListener('click', printGestureSheet);
      printBtn.addEventListener('mousedown', (e) => e.stopPropagation());
    }
    if (gestureBookBtn) gestureBookBtn.addEventListener('click', openGestureBook);
    if (closeGestureModal) {
      closeGestureModal.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        closeGestureBook();
      });
      closeGestureModal.addEventListener('mousedown', (e) => e.stopPropagation());
    }
    if (gestureModal) gestureModal.addEventListener('click', (e) => { 
      if (e.target === gestureModal) closeGestureBook(); 
    });
  </script>
  <script src="js/multimode.js"></script>
</body>
</html>
